Pulsar Deployment issues & notes:

1. Zookeeper leader election required excluding ports 2888,3888  -- solved by upgrading to istio 1.5.2 beta
2. Args "quorumListenOnAllIPs=true" added into zookeeper runtime.
3. Zookeeper also exposed via k8s service to bookkeeper & broker.
4. Need to advertise bookkeeper fqdn hostname to work with mTLS. -- make sure "PULSAR_PREFIX_useHostNameAsBookieID: "true" in values.yaml  
5. By advertising broker service name, new brokers are not able to create session with zookeeper
6. Zookeeper session not ending if broker restarted
7. POD's in broker deployment set by default not added into KubeDNS which required by mTLS - https://github.com/kubernetes/kubernetes/issues/60789
8. So, brokers converted as K8s Statefulset(Headless Service)
9. Headless service with Istio 1.4.2 having problem of handshaking with same POD - https://github.com/istio/istio/issues/12551
10. Upgrading to Istio 1.5 solved the handshaking problem.

Verify MTLS:
kubectl get meshpolicies default -o yaml
istioctl exp describe pod pulsaristio-bookkeeper-0.pulsaristio
istioctl authn tls-check pulsaristio-broker-0.pulsaristio  pulsaristio-broker.pulsaristio.svc.cluster.local

## Remove sidecar and Test mTLS
kubectl get deployment pulsaristio-bastion -n pulsaristio -o yaml | istioctl experimental kube-uninject -f - | kubectl apply -f -
bin/pulsar-client --url pulsar://pulsaristio-broker:6650 produce topic -m "hi"
bin/pulsar-admin --admin-url http://pulsaristio-broker-admin:8080 tenants list
bin/pulsar zookeeper-shell -server pulsaristio-zookeeper:2181

bin/pulsar-client --url pulsar://pulsaristio-proxy:6650 produce topic -m "hi"

kubectl get deployment pulsaristio-bastion -n pulsaristio -o yaml | istioctl kube-inject -f - | kubectl apply -f -
bin/pulsar-client --url pulsar://pulsaristio-broker:6650 produce topic -m "hi"
bin/pulsar-admin --admin-url http://pulsaristio-broker-admin:8080 tenants list
bin/pulsar zookeeper-shell -server pulsaristio-zookeeper:2181

